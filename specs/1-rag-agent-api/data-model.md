# Data Model: RAG Agent System

## Core Entities

### QueryRequest
**Description**: Represents a user query request to the RAG agent

**Fields**:
- `query_text` (string, required): The natural language query from the user
- `top_k` (integer, optional): Number of results to retrieve (default: 5, min: 1, max: 20)
- `temperature` (float, optional): Creativity control for response generation (default: 0.3)

**Validation Rules**:
- `query_text` must be 1-1000 characters
- `top_k` must be between 1-20
- `temperature` must be between 0.0-1.0

### RetrievedChunk
**Description**: A single chunk of content retrieved from the Qdrant database

**Fields**:
- `text` (string, required): The actual content text
- `source_url` (string, required): URL where the content was sourced from
- `chapter_title` (string, required): Title of the chapter this content belongs to
- `score` (float, required): Similarity score from the vector search

**Validation Rules**:
- All fields must be present
- `text` must not be empty
- `score` must be non-negative

### AgentResponse
**Description**: The response generated by the RAG agent

**Fields**:
- `query` (string, required): The original user query
- `response` (string, required): The agent's response to the query
- `context_used` (array[RetrievedChunk], required): List of chunks used to generate the response
- `thread_id` (string, optional): Thread ID for conversation continuity
- `execution_time_ms` (number, required): Time taken to process the query in milliseconds
- `timestamp` (string, required): ISO 8601 timestamp of the response
- `model_used` (string, required): The LLM model used for generation
- `error` (string, optional): Error message if the query failed

**Validation Rules**:
- `response` must be present (even if it's an error response)
- `context_used` must be an array of RetrievedChunk objects
- `execution_time_ms` must be non-negative

### AgentConfig
**Description**: Configuration parameters for the RAG agent

**Fields**:
- `model` (string, required): OpenAI model to use (default: "gpt-4-turbo")
- `top_k` (integer, required): Number of results to retrieve (default: 5)
- `temperature` (float, required): Response creativity control (default: 0.3)
- `retrieval_threshold` (float, optional): Minimum relevance score threshold

**Validation Rules**:
- `top_k` must be between 1-20
- `temperature` must be between 0.0-1.0
- `retrieval_threshold` must be between 0.0-1.0 if provided

## State Transitions

### Query Processing Flow
1. **Query Received**: User query is validated against QueryRequest schema
2. **Context Retrieval**: RetrievedChunk objects are generated from Qdrant search
3. **Response Generation**: AgentResponse is created using retrieved context
4. **Response Returned**: Final response is validated and returned to user

## Relationships

- One `QueryRequest` generates one `AgentResponse`
- One `AgentResponse` contains multiple `RetrievedChunk` objects
- One `AgentConfig` applies to multiple queries processed by the same agent instance